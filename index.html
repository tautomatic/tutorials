<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Wordpress as a Mobile CMS by tautomatic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Wordpress as a Mobile CMS</h1>
      <h2 class="project-tagline">Step-by-step guide to going headless with Wordpress</h2>
      <a href="https://github.com/tautomatic/tutorials" class="btn">View on GitHub</a>
      <a href="https://github.com/tautomatic/tutorials/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/tautomatic/tutorials/tarball/master" class="btn">Download .tar.gz</a>
    </section>
  <section class="main-content">
      <p>When it comes to publishing on the web, few platforms come close to Wordpress: it has a friendly user interface, vibrant developer community, and a large marketplace of custom themes, plugins, and professional services. However, very few people to date have taken the advantage of the Wordpress CMS to power mobile apps. Here are the immediate benefits such a setup would yield:   </p>

<ol>
<li>
<em>Faster development cycle</em>. Rather than building an API from the scratch, take an advantage of the functionality afforded by Wordpress.</li>
<li>
<em>Beautiful editor experience</em>. Wordpress was developed with authors in mind making it a perfect tool for creating mobile content.</li>
<li>
<em>Re-usable entries</em>. Using the same CMS for website and mobile content eliminates duplicate work, since the same entries can be published on web and mobile clients. </li>
<li>
<em>Real-time publishing</em>. With plugins like WP API, new content is available within a mobile app immediately after it is published.</li>
</ol>

<p>Are you convinced already? Great! This tutorial contains detailed steps for turning a Wordpress instance into a mobile CMS for managing the content of the iOS and Android apps. To reference more technical points of the tutorial, we shall use the <a href="https://itunes.apple.com/us/app/canopy-curated-shop-for-amazon/id927695605?mt=8">Canopy app</a> for iOS. Canopy features a curated list of cool gifts sold on Amazon and, importantly for us, has a straightforward structure that makes it an easy example to follow.</p>

<p><strong>NB</strong>: the tutorial assumes that you are comfortable with getting your hands dirty hacking Wordpress and its extensions. If that is not the case and you would rather find a ready to use solution, jump to the tutorial <a href="http://tautomatic.github.io/tutorials/wp/#parting-thoughts">closing section</a> for recommendations on practical alternatives you can use.</p>

<h3>
<a id="table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Table of Contents</h3>

<ul>
<li><a href="#requirements">Initial requirements</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#API">Working with the API</a></li>
<li><a href="#modelling">Defining content structure</a></li>
<li><a href="#extending-api">Extending the API</a></li>
<li><a href="#parting-thoughts">Parting thoughts</a></li>
<li><a href="#links">Useful links</a></li>
</ul>

<h3>
<a id="initial-requirements" class="anchor" href="#initial-requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="requirements"></a>Initial requirements</h3>

<p>To successfully complete this tutorial you will need the following credentials, tools and plugins:</p>

<ul>
<li>A hosted server with MySQL database</li>
<li>FTP credentials</li>
<li>An FTP client (<a href="https://cyberduck.io/">Cyberduck</a>, <a href="https://filezilla-project.org/">Filezilla</a>, <a href="http://www.panic.com/transmit/">Transmit</a>, etc.)</li>
<li>
<a href="http://wp-api.org/">Advanced Custom Fields (ACF)</a>, <a href="http://www.advancedcustomfields.com/add-ons/flexible-content-field/">WP API</a>, and <a href="https://github.com/times/acf-to-wp-api">ACF to WP API plugins</a></li>
<li>
<a href="https://wp-oauth.com/">WP OAuth Server</a> and <a href="https://wordpress.org/plugins/wp-basic-auth/">Basic Auth</a> plugins </li>
</ul>

<h3>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="installation"></a>Installation</h3>

<p>Download the latest version of Wordpress from <a href="https://wordpress.org/download/">https://wordpress.org/download/</a> and extract the contents of the ZIP archive. You could then follow the famous 5-minutes installation to get your instance of Wordpress up and running.</p>

<p><strong>Note.</strong> Before you start, make sure that your hosting provider includes a MySQL database in the hosting plan you selected. </p>

<p>The next step is to install plugins. In the menu on the left, navigate to <strong>Plugins &gt; Add New</strong>. In the <strong>Add Plugin</strong> screen, use the search bar to find a plugin and click <strong>Install</strong>. Once a plugin installed, activate it and you should see new menu items on the left.</p>

<p>We are interested in three plugins. <a href="http://wp-api.org/">Advanced Custom Fields</a> allows you to add custom fields to Wordpress. This will enable us to model the content structure of the mobile app. </p>

<p><a href="http://www.advancedcustomfields.com/add-ons/flexible-content-field/">WP API</a> exposes the website data through a REST API enabling mobile apps to communicate with your instance of Wordpress. It will be included in the core of the Wordpress starting with the version 4.1, but for now you have to install it manually.</p>

<p>Finally, the <a href="https://wp-oauth.com/">OAuth Server</a> plugin is required to authenticate your client for the use with WP API. </p>

<h3>
<a id="authentication" class="anchor" href="#authentication" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="authentication"></a>Authentication</h3>

<p>Before we go any further, we need to authenticate ourselves. Wordpress supports three types of <a href="http://wp-api.org/guides/authentication.html">authentication</a>:</p>

<ul>
<li><p><em>Cookie authentication</em>. Sets up a cookie once a user logs into a dashboard. The method is mostly used for authenticating Wordpress plugins and themes.</p></li>
<li><p><em>Basic authentication</em>. This method only requires a username and password. The client takes these two credentials and uses base64 encoding to transform them into a single string, e.g. <code>bG9naW46cGFzc3dvcmQ=</code> that gets passed to a server. This method requires the Basic Auth plugin to be installed.</p></li>
<li><p><em>OAuth authentication</em>. is the designated authentication method for external clients on mobile, web and desktop. Each client is issued with a unique token granting it access to API resources. This method requires OAuth server plugin to be installed on your Wordpress server.</p></li>
</ul>

<p>We will be using the OAuth method to communicate with the mobile app. The setup requires us to complete three steps: register the client (in our case, a mobile app) with the OAuth server, authenticate the client, and obtain an access token to be used for issuing routine API calls. </p>

<p>For the first step, head over to OAuth Server plugin settings and add a new client. 
<img src="http://i.imgur.com/wBnnV5p.png" alt="Oauth step one" align="middle"></p>

<p>After this you can click on the Clients Tab to view the generated Client ID:
<img src="http://i.imgur.com/BijldaA.png" alt="Oauth step two" align="middle"></p>

<p>Please note that the older version of the WP OAuth Server plugin required you to use the CLI to generate client key and secret. This tutorial references the latest version of the plugin (3.1.5), which allows you to perform these steps within the Wordpress admin interface.</p>

<p>Now use the newly created client ID and redirect URL to make a call to the authorization endpoint:</p>

<pre><code>    curl https://mysite.com/authorize?client_id=xxxxx&amp;redirect_uri=https://mysite.com/redirect-uri/&amp;response_type=token
</code></pre>

<p>Note that response type can be “token” or “code”. “Token” value should be used for client-side applications, where confidentiality of secrets cannot be guaranteed; “code” is used for server-side applications. Since we are working with the mobile app, we chose to indicate response type as “token”. This will result in a callback giving us the access token:</p>

<pre><code>    curl http://mysite.com/#access_token=xxxxx&amp;expires_in=86400&amp;token_type=Bearer&amp;scope=basic
</code></pre>

<p>If you would like to generate an access token for use on the server-side, the process includes an extra step. Following the authentication call, the OAuth server will respond with the Redirect URI along with a GET parameter containing the authorization code:  </p>

<pre><code>    https://mysite.com/redirect-uri/cb?code=xxx
</code></pre>

<p>You now have to combine your client ID, client secret and this code to make a POST call to the access token endpoint:</p>

<pre><code>    curl -u client_id:client_secret http://server.com/oauth/token -d ‘grant_type=authorization_code&amp;code=xxx’
</code></pre>

<p>At this point, you should have an access token, which will enable you to create, update and delete posts and other entities via the WP API plugin. All you need to do is to attach the access token to your API call as indicated below:</p>

<pre><code>    https://mysite.com/wp-json/posts/34/revisions?access_token=xxxxx
</code></pre>

<h3>
<a id="working-with-the-api" class="anchor" href="#working-with-the-api" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="API"></a>Working with the API</h3>

<p>If you are just getting to grips with APIs, you might want to consider installing the <a href="https://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm?hl=en">Postman</a> or <a href="https://chrome.google.com/webstore/detail/dhc-resthttp-api-client/aejoelaoggembcahagimdiliamlcdmfm?hl=en">Dev HTTP Client</a> plugin (both only available for Chrome at the moment). The plugins take a lot of hassle out of working with APIs, since they come with smart defaults, transform entered variables into syntactically correct API calls, and display nicely formatted responses. </p>

<p>Here’s a snapshot of the Postman tool:
<img src="http://i.imgur.com/W0s4gWK.jpg" alt="Postman REST API plugin" align="middle"></p>

<p>For those of you using a terminal to run API queries, you will notice that WP API responses are sometimes hard to read due to poor formatting. This issue can be easily corrected by installing the <a href="http://stedolan.github.io/jq/">jq utility</a> on your machine. jq is a library for processing JSON objects and among the many things it does, it can also produce nicely formatted JSON responses. To install jq, run:</p>

<pre><code>    brew install jq
</code></pre>

<p>Now add the option ‘| jq ‘.’’ at the end of your call and you get a nicely formatted API response.</p>

<pre><code>    curl http://mysite.com/wp-json/wp/v2/posts/1 | jq ‘.’ 
</code></pre>

<p>With the basics covered, we can now finally ready to take WP API for a spin. In your terminal (or plugin window) type the command to fetch all the posts from your Wordpress website: </p>

<pre><code>    curl http://mysite.com/wp-json/wp/v2/posts
</code></pre>

<p>The response should look similar to this:</p>

<div class="highlight highlight-source-json"><pre>[
{
<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>:<span class="pl-c1">26</span>,
<span class="pl-s"><span class="pl-pds">"</span>date<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>2015-08-06T08:50:45<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>guid<span class="pl-pds">"</span></span>:{<span class="pl-s"><span class="pl-pds">"</span>rendered<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>http:<span class="pl-cce">\/\/</span>mysite.com<span class="pl-cce">\/</span>?p=26<span class="pl-pds">"</span></span>},
<span class="pl-s"><span class="pl-pds">"</span>modified<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>2015-08-06T08:50:45<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>modified_gmt<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>2015-08-06T08:50:45<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>slug<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>my-slug<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>post<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>link<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>http:<span class="pl-cce">\/\/</span>mysite.com<span class="pl-cce">\/</span>wp-api<span class="pl-cce">\/</span>post1<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>title<span class="pl-pds">"</span></span>:{<span class="pl-s"><span class="pl-pds">"</span>rendered<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>Title name<span class="pl-pds">"</span></span>},
<span class="pl-s"><span class="pl-pds">"</span>content<span class="pl-pds">"</span></span>:{<span class="pl-s"><span class="pl-pds">"</span>rendered<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>&lt;p&gt;# Description&lt;<span class="pl-cce">\/</span>p&gt;<span class="pl-cce">\n</span>&lt;p&gt;A long descriptive text&lt;<span class="pl-cce">\/</span>p&gt;<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>},
<span class="pl-s"><span class="pl-pds">"</span>author<span class="pl-pds">"</span></span>:<span class="pl-c1">1</span>,
<span class="pl-s"><span class="pl-pds">"</span>featured_image<span class="pl-pds">"</span></span>:<span class="pl-c1">0</span>,
<span class="pl-s"><span class="pl-pds">"</span>comment_status<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>open<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>ping_status<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>open<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>sticky<span class="pl-pds">"</span></span>:<span class="pl-c1">false</span>,
<span class="pl-s"><span class="pl-pds">"</span>format<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>standard<span class="pl-pds">"</span></span>,
<span class="pl-s"><span class="pl-pds">"</span>_links<span class="pl-pds">"</span></span>:
{
<span class="pl-s"><span class="pl-pds">"</span>self<span class="pl-pds">"</span></span>:
[{<span class="pl-s"><span class="pl-pds">"</span>href<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>http:<span class="pl-cce">\/\/</span>mysite.com<span class="pl-cce">\/</span>wp-json<span class="pl-cce">\/</span>wp<span class="pl-cce">\/</span>v2<span class="pl-cce">\/</span>posts<span class="pl-cce">\/</span>26<span class="pl-pds">"</span></span>}],
<span class="pl-s"><span class="pl-pds">"</span>collection<span class="pl-pds">"</span></span>:[{<span class="pl-s"><span class="pl-pds">"</span>href<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>http:<span class="pl-cce">\/\/</span>mysite.com<span class="pl-cce">\/</span>wp-json<span class="pl-cce">\/</span>wp<span class="pl-cce">\/</span>v2<span class="pl-cce">\/</span>posts<span class="pl-pds">"</span></span>}],
<span class="pl-s"><span class="pl-pds">"</span>author<span class="pl-pds">"</span></span>:[{<span class="pl-s"><span class="pl-pds">"</span>embeddable<span class="pl-pds">"</span></span>:<span class="pl-c1">true</span>,<span class="pl-s"><span class="pl-pds">"</span>href<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>http:<span class="pl-cce">\/\/</span>mysite.com<span class="pl-cce">\/</span>wp-json<span class="pl-cce">\/</span>wp<span class="pl-cce">\/</span>v2<span class="pl-cce">\/</span>users<span class="pl-cce">\/</span>1<span class="pl-pds">"</span></span>}],
<span class="pl-s"><span class="pl-pds">"</span>replies<span class="pl-pds">"</span></span>:[{<span class="pl-s"><span class="pl-pds">"</span>embeddable<span class="pl-pds">"</span></span>:<span class="pl-c1">true</span>,
<span class="pl-s"><span class="pl-pds">"</span>href<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>http:<span class="pl-cce">\/\/</span>mysite.com<span class="pl-cce">\/</span>wp-json<span class="pl-cce">\/</span>wp<span class="pl-cce">\/</span>v2<span class="pl-cce">\/</span>comments?post_id=26<span class="pl-pds">"</span></span>}],
<span class="pl-s"><span class="pl-pds">"</span>version-history<span class="pl-pds">"</span></span>:[{<span class="pl-s"><span class="pl-pds">"</span>href<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>http:<span class="pl-cce">\/\/</span>mysite.com<span class="pl-cce">\/</span>wp-json<span class="pl-cce">\/</span>wp<span class="pl-cce">\/</span>v2<span class="pl-cce">\/</span>posts<span class="pl-cce">\/</span>26<span class="pl-cce">\/</span>revisions<span class="pl-pds">"</span></span>}]<span class="pl-ii">....</span></pre></div>

<p>To view the data from a single post, you can send a GET request to the post itself:</p>

<pre><code>    curl http://mysite.com/wp-json/wp/v2/posts/1
</code></pre>

<p>Deleting a post, requires the client to provide the access token, but otherwise follows the familiar pattern:</p>

<pre><code>    curl -X DELETE http://mysite.com/wp-json/wp/v2/posts/4?access_token=xxxxx
</code></pre>

<p>For creating a post, let’s first create a simple JSON file with some dummy data and call it first-post.json:</p>

<pre><code>    {
        “title”: “My first API post”,
        “content_raw”: “Once upon a time, there was a HTTP request…”,
        “name”: “my-first-api-post”
        “category”: “Tutorials”,
        “comment_status”: “open”,
        “tags”: [“biography”,”computers”,”api”]
    }
</code></pre>

<p>Now add this entry to the post collection:</p>

<pre><code>    curl -X POST http://mysite.com/wp-json/wp/v2/posts?access_token=xxxxx --data @first-post.json https://mysite.com/authorize?client_id=LJkqIAmqUIdEssIRalbS1kUV2QX0nz&amp;redirect_uri=https://mysite.com/redirect/redirect-uri&amp;response_type=token
</code></pre>

<p>If you follow the steps correctly, you should receive a 201 status indicating that the post has been created.</p>

<p>Congratulations, you are now ready to interact with all the default Wordpress entities - including users, media and comments - through the API. At the very least, that should enable you to build a blogging mobile app. But what do you do if you want to go beyond blogging? That is the topic of our next section.</p>

<h3>
<a id="content-modeling" class="anchor" href="#content-modeling" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="modelling"></a>Content modeling</h3>

<p>Let’s go back to the original purpose of our tutorial, namely, building a simple, curated shopping app inspired by the <a href="https://itunes.apple.com/us/app/canopy-curated-shop-for-amazon/id927695605?mt=8">Canopy</a> example. To manage the app from Wordpress, we have to modify the default content model to accommodate the data that our app will require. A quick look at Canopy app reveals that it works with three major content types:</p>

<ul>
<li>
<em>Products</em> contain all the information about the merchandise, including the price, images, tags, relevant categories and external URL. The content type further references user comments, but we can skip them for now. </li>
<li>
<em>Users</em> hold user bio, collections, comments and whom she follows on the platform. The content type also references products liked by user.</li>
<li>
<em>Brands</em> describe the brand and contain a brand logo, URL, short description and reference the relevant products.</li>
</ul>

<p>The illustration below provides a more detailed deconstruction of the content types. </p>

<p><strong>Content Type: Product</strong></p>

<table>
<thead>
<tr>
<th>App UI</th>
<th>Content structure</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="http://i.imgur.com/qUUQ0Uk.jpg" alt="App snapshot 1"></td>
<td>Title // Text<br> Description // Text<br> Featured image // Image<br> Product images // Multiple images<br> Brand // Linked entry [Brand]<br> Editor’s note // Text<br> Price // Number<br> Amazon URL // Text + valid URL<br> Number of likes // Number<br> User comments // Linked entries [Comment]<br> Found by // Linked entry [User]<br> Product category // Text array + predefined<br> Product tags // Text array + predefined<br>
</td>
</tr>
</tbody>
</table>

<p><strong>Content Type: User</strong></p>

<table>
<thead>
<tr>
<th>App UI</th>
<th>Content structure</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="http://i.imgur.com/oetOZW2.png" alt="App snapshot 2"></td>
<td>Photo // Image<br> Full name // Text<br> Username // Text<br> Email address // Text + valid email<br> Bio // Text<br> Personal link // Text + valid URL<br> Created collections // Linked entry [Collection]<br> Likes // Linked entries [Product]<br> Comments // Linked entry [Comments]<br> Users followed // Linked entries [Users]<br> Brands followed // Linked entries [Brands]<br> Found products // Linked entries [Product]<br>
</td>
</tr>
</tbody>
</table>

<p><strong>Content Type: Brand</strong></p>

<table>
<thead>
<tr>
<th>App UI</th>
<th>Content structure</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="http://i.imgur.com/9facQ0L.jpg" alt="App snapshot 3"></td>
<td>Logo // Image<br> Brand name // Text<br> Description // Text<br> Brand link // Text + valid URL<br> Featured image // Image<br> Products // Linked entries [Product]<br> Followers // Linked entries [Users]<br>
</td>
</tr>
</tbody>
</table>

<p>Now, let’s use the Advanced Custom Fields (ACF) plugin to add the new content types to our Wordpress instance. You will notice that the plugin gives you a lot of options when it comes to choosing a field type or defining default inputs. Once you have created custom posts for a product, user and brand, navigate to the entry editor and you will see the fields you added displayed there. </p>

<p>If you plan to have fields containing arrays of items, say, multiple product images or related collections, I advise you splash out $25 on getting the <a href="http://www.advancedcustomfields.com/add-ons/repeater-field/">Repeater field</a> add-on. The Repeater field acts as a table of data where you can define the columns and add infinite rows. Editors will definitely appreciate the flexibility this add-on brings to working with fields that can run a dozen of sub-entries. </p>

<img src="http://i.imgur.com/Nz5upSg.png?1" title="ACF Repeater fields in action" align="middle"/>

<p>A special note on navigation. Since Wordpress was designed with a static content model in mind, keeping track of all the extra fields you add can be a bit unwieldy. You will save yourself a lot of trouble by using ‘location rules’ and ‘hide on screen’ options under the ACF plugin to craft a custom post type displaying only the fields you need. I found that using specific post formats or categories to trigger custom layouts works best. </p>

<h4>
<a id="adding-validations" class="anchor" href="#adding-validations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding validations</h4>
 
<p>In some cases, for example, when working with fields referencing other objects (e.g. users, brands, collections) or having URL fields, you’d be wise to add field-level validations to your content types. This way, editors will be prompted to correct invalid input before saving an entry. Unfortunately, ACF plugin does not allow adding validations inline, but it is possible to add validations directly to the code. </p>

<p><a href="http://www.advancedcustomfields.com/resources/acf-validate_value/">ACF page</a> contains official documentation on how to add custom validation to your content types. In short, <code>acf/update_value</code> filter allows you to specify which field to validate by referencing its type, name or key. Note that failing to specify any of these arguments would mean that the validation applies to <strong>all</strong> ACF fields. Since we want granular control, we will use field key value “field_ABC” to select the specific field: </p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">    <span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1">        add_filter(<span class="pl-s"><span class="pl-pds">'</span>acf/validate_value/key=field_ABC<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>acf_validate_image_width<span class="pl-pds">'</span></span>, <span class="pl-c1">10</span>, <span class="pl-c1">4</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-k">function</span> <span class="pl-en">acf_validate_image_width</span>( <span class="pl-smi">$valid</span>, <span class="pl-smi">$value</span>, <span class="pl-smi">$field</span>, <span class="pl-smi">$input</span> ){  </span>
<span class="pl-s1">        <span class="pl-c">// bail early if value is already invalid</span></span>
<span class="pl-s1">        <span class="pl-k">if</span>( <span class="pl-k">!</span><span class="pl-smi">$valid</span> ) {</span>
<span class="pl-s1">            <span class="pl-k">return</span> <span class="pl-smi">$valid</span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-c">// load image data</span></span>
<span class="pl-s1">        <span class="pl-smi">$data</span> <span class="pl-k">=</span> wp_get_attachment_image_src( <span class="pl-smi">$value</span>, <span class="pl-s"><span class="pl-pds">'</span>full<span class="pl-pds">'</span></span> );</span>
<span class="pl-s1">        <span class="pl-smi">$width</span> <span class="pl-k">=</span> <span class="pl-smi">$data</span>[<span class="pl-c1">1</span>];</span>
<span class="pl-s1">        <span class="pl-smi">$height</span> <span class="pl-k">=</span> <span class="pl-smi">$data</span>[<span class="pl-c1">2</span>];</span>
<span class="pl-s1">        <span class="pl-k">if</span>( <span class="pl-smi">$width</span> <span class="pl-k">&lt;</span> <span class="pl-c1">960</span> ) {</span>
<span class="pl-s1">          <span class="pl-smi">$valid</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Image must be at least 960px wide<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-c">// return</span></span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$valid</span>;  </span>
<span class="pl-s1">        }    </span></pre></div>

<p>You can see that add_filter function has four parameters: </p>
<ol>
<li> <code>acf/validate_value/key=field_ABC</code>: filter for a specific field </li>
<li> <code>acf_validate_image_width</code>: validation function </li>
<li> <code>10</code>: priority in which filter is applied (10 is WP default value) </li>
<li> <code>4</code>: the number of parameters to be used in our custom validation function </li>
</ol>

<p>Our custom function <code>acf_validate_image_width</code> then fetches the attached image data and verifies that it conforms to the requirements set in the validation: it should be at least 960 px wide. We can add a custom error message informing editor about the requirement to the <code>$valid</code> argument. </p>

<h3>
<a id="extending-the-api" class="anchor" href="#extending-the-api" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="extending-api"></a>Extending the API</h3>

<p>Now that you have the content model of your mobile app defined, it is time to make it accessible via the API. Unfortunately, WP API does not expose custom fields by default. For that you either need to add a <a href="http://stackoverflow.com/questions/10132685/json-api-to-show-advanced-custom-fields-wordpress">piece of code manually</a> or use the <a href="https://github.com/times/acf-to-wp-api">ACF to WP API</a>, which does the job for you.  

<p>Going down the WP API route will make custom fields accessible via the API, but what we really need is a way to access custom posts such as products, brands or users, which include only the fields we defined when creating these content types present. The most elegant solution would be to create custom API endpoints allowing mobile app to fetch each type of entries by calling a single URL. This way, we would keep our code readable, reduce API latency and save precious bandwidth. </p>

<p>Adding custom endpoints to WP API is a long-winding process that requires the knowledge of WP’s inner workings, so let’s break it down into specific steps. We start by writing a simple function in the <code>functions.php</code> file that gathers custom fields for a product type:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">    <span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">     * Fetch custom post type</span></span>
<span class="pl-s1"><span class="pl-c">     *</span></span>
<span class="pl-s1"><span class="pl-c">     * @ param array $data Options for the function.</span></span>
<span class="pl-s1"><span class="pl-c">     * @ return string|null Post title for the latest,  * or null if none.</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">     <span class="pl-k">function</span> <span class="pl-en">fetch_product</span>( <span class="pl-smi">$data</span> ) {</span>
<span class="pl-s1">          <span class="pl-smi">$product</span> <span class="pl-k">=</span> get_posts( <span class="pl-c1">array</span>(</span>
<span class="pl-s1">              <span class="pl-s"><span class="pl-pds">'</span>post_type<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-smi">$data</span>[<span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span>],</span>
<span class="pl-s1">          ) );</span>
<span class="pl-s1">          <span class="pl-k">if</span> ( <span class="pl-c1">empty</span>( <span class="pl-smi">$product</span> ) ) {</span>
<span class="pl-s1">              <span class="pl-k">return</span> <span class="pl-c1">null</span>;</span>
<span class="pl-s1">          }</span>
<span class="pl-s1">          <span class="pl-k">return</span> <span class="pl-smi">$product</span>;</span>
<span class="pl-s1">      }</span></pre></div>

<p>Next step is to make this function available via the API. For that, we register a route, which will instruct the API to respond to a request for a product entry with out function. This is done with the <code>register_rest_route</code> function called in a callback on <code>rest_api_init</code> function. Let's say that we want to create a new API endpoint with the URL <code>http://mysite.com/wp-api/wp/v2/posts/123</code>. We need to specify three arguments to make this code work:</p>

<ul>
<li><code>Namespace</code>: the first part of the URL that should follow the familiar <code>vendor/v1</code> pattern. In the URL above, the namespace is 'wp-api'.</li>
<li><code>Route</code>: the remaining part of the URL used to access endpoints. In our reference URL, the route is 'wp/v2/posts/123' part.</li>
<li><code>Options</code>: specifies the options associated with the custom endpoint. These include the familiar HTTP methods (GET, POST, PUT, DELETE), a corresponding callback function, any validations, default values and so on. </li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">    <span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1">    add_action( <span class="pl-s"><span class="pl-pds">'</span>rest_api_init<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> () {</span>
<span class="pl-s1">        register_rest_route( <span class="pl-s"><span class="pl-pds">'</span>canopy/v1<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>/author/(?P\d+)<span class="pl-pds">'</span></span>, <span class="pl-c1">array</span>(</span>
<span class="pl-s1">            <span class="pl-s"><span class="pl-pds">'</span>methods<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>GET<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">            <span class="pl-s"><span class="pl-pds">'</span>callback<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>fetch_product<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">            <span class="pl-s"><span class="pl-pds">'</span>args<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">array</span>(</span>
<span class="pl-s1">            <span class="pl-s"><span class="pl-pds">'</span>id<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">array</span>(</span>
<span class="pl-s1">                <span class="pl-s"><span class="pl-pds">'</span>validate_callback<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>is_numeric<span class="pl-pds">'</span></span></span>
<span class="pl-s1">            ),</span>
<span class="pl-s1">        ),</span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>permission_callback<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-k">function</span> () {</span>
<span class="pl-s1">            <span class="pl-k">return</span> current_user_can( <span class="pl-s"><span class="pl-pds">'</span>edit_others_posts<span class="pl-pds">'</span></span> );</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">    ) );</span>
<span class="pl-s1">} );</span></pre></div>

and one more
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">    <span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">     * Get one item from the collection</span></span>
<span class="pl-s1"><span class="pl-c">     *</span></span>
<span class="pl-s1"><span class="pl-c">     * <span class="pl-k">@param</span> WP_REST_Request $request Full data about the request.</span></span>
<span class="pl-s1"><span class="pl-c">     * <span class="pl-k">@return</span> WP_Error|WP_REST_Response</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">    <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">get_item</span>( <span class="pl-smi">$request</span> ) {</span>
<span class="pl-s1">        <span class="pl-c">//get parameters from request</span></span>
<span class="pl-s1">        <span class="pl-smi">$params</span> <span class="pl-k">=</span> <span class="pl-smi">$request</span><span class="pl-k">-&gt;</span>get_params();</span>
<span class="pl-s1">        <span class="pl-smi">$item</span> <span class="pl-k">=</span> <span class="pl-c1">array</span>();<span class="pl-c">//do a query, call another class, etc</span></span>
<span class="pl-s1">        <span class="pl-smi">$data</span> <span class="pl-k">=</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>prepare_item_for_response( <span class="pl-smi">$item</span>, <span class="pl-smi">$request</span> );</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-c">//return a response or error based on some conditional</span></span>
<span class="pl-s1">        <span class="pl-k">if</span> ( <span class="pl-c1">1</span> <span class="pl-k">==</span> <span class="pl-c1">1</span> ) {</span>
<span class="pl-s1">            <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-c1">WP_REST_Response</span>( <span class="pl-smi">$data</span>, <span class="pl-c1">200</span> );</span>
<span class="pl-s1">        }<span class="pl-k">else</span>{</span>
<span class="pl-s1">            <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-c1">WP_Error</span>( <span class="pl-s"><span class="pl-pds">'</span>code<span class="pl-pds">'</span></span>, __( <span class="pl-s"><span class="pl-pds">'</span>message<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>text-domain<span class="pl-pds">'</span></span> ) );</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">    }</span></pre></div>

<p>After your callback is called, the return value is then converted to JSON, and returned to the client. This allows you to return basically any form of data. In our example above, we’re returning either a string or null, which are automatically handled by the API and converted to JSON.</p>

<p>Like any other WordPress function, you can also return a <code>WP_Error</code> instance. This error information will be passed along to the client, along with a 500 Internal Service Error status code. You can further customize your error by setting the status option in the <code>WP_Error</code> instance data to a code, such as 400 for bad input data.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">    <span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1">    <span class="pl-c">/**</span></span>
<span class="pl-s1"><span class="pl-c">        * Grab latest post title by an author!</span></span>
<span class="pl-s1"><span class="pl-c">    *</span></span>
<span class="pl-s1"><span class="pl-c">        * <span class="pl-k">@param</span> array $data Options for the function.</span></span>
<span class="pl-s1"><span class="pl-c">        * <span class="pl-k">@return</span> string|null Post title for the latest,</span></span>
<span class="pl-s1"><span class="pl-c">        * or null if none.</span></span>
<span class="pl-s1"><span class="pl-c">     */</span></span>
<span class="pl-s1">    <span class="pl-k">function</span> <span class="pl-en">my_awesome_func</span>( <span class="pl-smi">$data</span> ) {</span>
<span class="pl-s1">        <span class="pl-smi">$posts</span> <span class="pl-k">=</span> get_posts( <span class="pl-c1">array</span>(</span>
<span class="pl-s1">            ‘<span class="pl-c1">author</span>’ <span class="pl-k">=&gt;</span> <span class="pl-smi">$data</span>[‘<span class="pl-c1">id</span>’],</span>
<span class="pl-s1">       ) );</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-k">if</span> ( <span class="pl-c1">empty</span>( <span class="pl-smi">$posts</span> ) ) {</span>
<span class="pl-s1">            <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-c1">WP_Error</span>( ‘<span class="pl-c1">awesome_no_author</span>’, ‘<span class="pl-c1">Invalid</span>    <span class="pl-c1">author</span>’, <span class="pl-c1">array</span>( ‘<span class="pl-c1">status</span>’ <span class="pl-k">=&gt;</span> <span class="pl-c1">404</span> ) );</span>
<span class="pl-s1">      }</span>
<span class="pl-s1"></span>
<span class="pl-s1">      <span class="pl-k">return</span> <span class="pl-smi">$posts</span>[<span class="pl-c1">0</span>]<span class="pl-k">-&gt;</span><span class="pl-smi">post_title</span>;</span>
<span class="pl-s1">    }</span></pre></div>

<h4>
<a id="permission-callback" class="anchor" href="#permission-callback" aria-hidden="true"><span class="octicon octicon-link"></span></a>Permission callback</h4>

<p>You can also register a permissions callback for the endpoint. This is a function that checks if the user can perform the action (reading, updating, etc) before the real callback is called. This allows the API to tell the client what actions they can perform on a given URL without needing to attempt the request first.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">    <span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1">    add_action( ‘<span class="pl-c1">rest_api_init</span>’, <span class="pl-k">function</span> () {</span>
<span class="pl-s1">        register_rest_route( ‘<span class="pl-c1">myplugin</span><span class="pl-k">/</span><span class="pl-c1">v1</span>’, ‘<span class="pl-k">/</span><span class="pl-c1">author</span><span class="pl-k">/</span>(?<span class="pl-c1">P</span><span class="pl-k">&lt;</span><span class="pl-c1">id</span><span class="pl-k">&gt;</span>\<span class="pl-c1">d</span><span class="pl-k">+</span>)’,  <span class="pl-c1">array</span>(</span>
<span class="pl-s1">            ‘<span class="pl-c1">methods</span>’ <span class="pl-k">=&gt;</span> ‘<span class="pl-c1">GET</span>’,</span>
<span class="pl-s1">            ‘<span class="pl-c1">callback</span>’ <span class="pl-k">=&gt;</span> ‘<span class="pl-c1">my_awesome_func</span>’,</span>
<span class="pl-s1">            ‘<span class="pl-c1">args</span>’ <span class="pl-k">=&gt;</span> <span class="pl-c1">array</span>(</span>
<span class="pl-s1">                ‘<span class="pl-c1">id</span>’ <span class="pl-k">=&gt;</span> <span class="pl-c1">array</span>(</span>
<span class="pl-s1">                    ‘<span class="pl-c1">validate_callback</span>’ <span class="pl-k">=&gt;</span> ‘<span class="pl-c1">is_numeric</span>’</span>
<span class="pl-s1">                ),</span>
<span class="pl-s1">            ),</span>
<span class="pl-s1">            ‘<span class="pl-c1">permission_callback</span>’ <span class="pl-k">=&gt;</span> <span class="pl-k">function</span> () {</span>
<span class="pl-s1">                <span class="pl-k">return</span> current_user_can( ‘<span class="pl-c1">edit_others_posts</span>’ );</span>
<span class="pl-s1">            }</span>
<span class="pl-s1">        ) );</span>
<span class="pl-s1">    } );</span></pre></div>

<p>You have to repeat the same step to extend the custom route with additional endpoints for POST, PUT and DELETE actions. And then repeat the process for the remaining two content types. At the end of this exercise, you should have a custom API enabling you to manage the content of the app directly from Wordpress.</p>

<h3>
<a id="parting-thoughts" class="anchor" href="#parting-thoughts" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="parting-thoughts"></a>Parting thoughts</h3>

<p>If you have successfully arrived at this point, you now can enjoy a user-friendly interface to manage the content on your mobile app. I am also certain that the time necessary to get this solution app and running is significantly shorter than the alternative of building it from the scratch. However, before you launch the next Instagram on this purpose-built setup, keep a few important caveats in mind.</p>

<p>Security of Wordpress projects always looms large in my mind. You would be wise to invest into custom-proofing your backend from hacks and security exploits. Enable 2-factor authentication on your account and consider allowing only authorized IP-addresses to access the login area. Remove any unused plugin, theme or extension and make sure you upgrade the ones you use regularly. Although having said that, the fact that many plugin developers fail to provide comprehensive, up-to-date documentation or maintain compatibility with the older versions of the platform sometimes makes this last point tricky to implement in practice.</p>

<p>Then there are the bandwidth caps that come with your hosting plan. Be proactive, investigate in advance how your hosting provider will react to the sudden spike in traffic to your app. To stay on top of things, add the <a href="https://wordpress.org/plugins/tags/uptime-monitoring/">uptime monitoring</a> plugin to your website. This way, you will get a notification whenever your WP mBaaS backend goes down.</p>

<p>The most disconcerting fact, though, has to do with the latency and performance of the WP API. A couple of development teams that work with this setup have mentioned that API response times could extend up to 4 seconds and since the API does not provide sync functionality (which would allow the mobile client to get just the entries that have changed since the last time) or support parallel querying the resulting user experience is often sluggish. 
</p>

<p>If any of these problems ring the bell, or you are simply not familiar enough with the Wordpress platform to extend its API and fine tune OAuth calls, then I suggest you look at purpose-built mobile backends instead. The three names that get a lot of mentions are <a href="https://www.parse.com/">Parse</a>, <a href="https://www.contentful.com/">Contentful</a> and <a href="https://prismic.io/">Prismic</a>. I have used the latter two for my hobby projects and found the initial setup and customization did not require any major coding skills. So if your PHP skills are rusty, these tools offer a good alternative.</p>

<p>Hope the tutorial was useful for you. If you notice any inconsistencies or spot useful tools facilitating the process, let me know, and I would be happy to update the post.</p>

<h3>
<a id="useful-links" class="anchor" href="#useful-links" aria-hidden="true"><span class="octicon octicon-link"></span></a><a name="links"></a>Useful links</h3>

<p>Links below point to more detailed resources on the relevant topics: </p>

<ul>
<li>
<a href="https://aaronparecki.com/articles/2012/07/29/1/oauth2-simplified">https://aaronparecki.com/articles/2012/07/29/1/oauth2-simplified</a><br>
</li>
<li>
<a href="http://hasin.me/2015/07/18/using-oauth2-to-make-authenticated-calls-to-wp-rest-api/">http://hasin.me/2015/07/18/using-oauth2-to-make-authenticated-calls-to-wp-rest-api/</a><br>
</li>
<li>
<a href="https://deliciousbrains.com/creating-mobile-app-wp-api-react-native/">https://deliciousbrains.com/creating-mobile-app-wp-api-react-native/</a><br>
</li>
<li>
<a href="https://zapier.com/learn/apis/">https://zapier.com/learn/apis/</a><br>
</li>
</ul>
      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/tautomatic/tutorials">Wordpress as a Mobile CMS</a> is maintained by <a href="https://github.com/tautomatic">tautomatic</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-72301429-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
